<!DOCTYPE html>
<html>
<head>
    <title>Setup</title>
    <link rel="stylesheet" href="style/main.css"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/api.js"></script>
    <meta charset="utf-8">


</head>
<body>
    <main>
        <div id="content">


            <div id="config-db" class="hide">
                <h1>Setup Database</h1>
                <p>The database is not configured</p>
                <form id="form-db">
                    <label for="admin_mail">Admin mail</label>
                    <input type="email" name="admin_mail" id="admin_mail" required>

                    <label for="admin_password">Admin password</label>
                    <input type="password" name="admin_password" id="admin_password" required>

                    <label for="admin_firstname">Admin firstname</label>
                    <input type="text" name="admin_firstname" id="admin_firstname" required>

                    <label for="admin_lastname">Admin lastname</label>
                    <input type="text" name="admin_lastname" id="admin_lastname" required>
                    
                    <input type="submit" onclick="setupDBForm()" value="Valider">
                </form>
            </div>



            <!-- Categories on left side of the screen -->
            <div id="categories" class="col-2 hide">
                <ul>
                    <li class="row"><h3>Users</h3></li>
                    <li class="row"><h3>Permissions</h3> </li>
                    <li class="row"><h3>Logs</h3></li>
                    <li class="row"><h3>API Rest</h3></li>
                    <li class="row"><h3>Statistiques</h3> </li>
                </ul>
            </div>

            <!-- Navigation history -->
            <div id="nav-history" class="hide">
                <a href="#">Home</a> > <a href="#">Users</a> > <a href="#">Create</a>
            </div>
            

            <div id="category-content" class="hide"></div>

            <div id="modal" class="hide">
                <div id="modal-content">
                    <h2 id="modal-title">Modal</h2> 
                    <button id="modal-close">X</button>
                    <hr>
                    <div id="modal-text"></div>
                </div>
            </div>

        </div>
    </main>

    <script>
    let category_content;
    let modal;
    let roles = [];
    let users = [];
    let actions = [];
    let current_modal_id = false;


    window.onload = async function() {
        category_content = document.getElementById("category-content");
        modal = document.getElementById("modal");
        checkDBSetup();
        /* Categories click */
        let categories = document.getElementById("categories").getElementsByTagName("li");
        Array.from(categories).forEach(function(category) {
            category.addEventListener("click", function() {
                setCategory(category);
            });
        });

        let update_module = await request("Core", "Route", "Module", "Core", "PATCH");

        let role_response = await request("Core", "Permission", "Role", false, "GET");
        roles = role_response.data.roles;

        let user_response = await request("Core", "Permission", "User", false, "GET");
        users = user_response.data.users;

        let action_response = await request("Core", "Route", "Action", false, "GET");
        actions = action_response.data.actions;

    }


    // category_content.appendChild(await createLogCategory());
    //     } else if(category.innerText == "API Rest") {
    //         category_content.appendChild(await createAPIRestCategory());
    //     } else if(category.innerText == "Statistiques") {
    //         category_content.appendChild(await createStatistiquesCategory());

    /** API REST CATEGORY PART*/
    async function createAPIRestCategory() {
        let category_api = document.createElement("div");

        let response = await request("Core", "Route", "Module", id = false, method = "GET");
        console.log(response);
    }

    /** ROLE CATEGORY PART **/
    async function createPermissionCategory() {
        let category_permission = document.createElement("div");

        let response = await request("Core", "Permission", "Role", id = false, method = "GET");
        category_permission.appendChild(createSubPart("Roles list"));
        category_permission.appendChild(createTable(response.data.roles,
            { 
                id : "Role ID",
                role_name : "Name",
                role_description : "Description",
                creationDate : "Creation date"
            },
            {   
                Delete : deleteRole
            },
            {
                id : roleDetails
            },
            false,
            {
                label : "Create",
                needed_columns : ["role_name", "role_description"],
                function : createRole
            }

        ));

        return category_permission;
    }

    async function deleteRole(id, lineElement) {
        let response = await request("Core", "Permission", "Role", id, "DELETE");
        if(!response.success) promptError(response);
        return response.success;
    }

    async function createRole(id, data) {
        let response = await request("Core", "Permission", "Role", false, "POST", data);
        if(!response.success) promptError(response);
        return response.success ? response.data.role : false;
    }
    


    /** USER CATEGORY PART **/
    async function createUserCategory() {
        let category_user = document.createElement("div");

        let response = await request("Core", "Permission", "User", id = false, method = "GET");
        category_user.appendChild(createSubPart("Users list"));
        
        category_user.appendChild(createTable(response.data.users,
            { 
                id : "User ID",
                email :"E-mail",
                username : "Login",
                first_name : "First name",
                last_name : "Last name",
                creationDate : "Subscription"
            },
            {   
                delete : deleteUser
            },
            {
                id : userDetails
            },
            false
        ));

        return category_user;
    }

    async function deleteUser(id, lineElement) {
        let response = await request("Core", "Permission", "User", id, "DELETE");
        if(!response.success) promptError(response);
        return response.success;
    }

    /** ROLE DETAILS PART **/
    async function roleDetails(id) {
        let response = await request("Core", "Permission", "Role", id, "GET");
        if(response.success) {

            let role = response.data.role;
            let role_details = document.createElement("div");

            role_details.appendChild(createDataList(
                role,
                {
                    id : "Role ID",
                    role_name : "Name",
                    role_description : "Description",
                    creationDate : "Creation date"
                },
                {
                    role_name : editRole,
                    role_description : editRole
                }
            ));
            role_details.appendChild(document.createElement("hr"));;
            

            // Get users with this role
            let users_with_role = document.createElement("div");
            users_with_role.classList.add("users-with-role");
            users_with_role.innerHTML = `<h3>Users with this role</h3>`;
            users_with_role.appendChild(createTable(response.data.users,
                {
                    id : "User ID",
                    email :"E-mail",
                    username : "Login",
                    first_name : "First name",
                    last_name : "Last name",
                    creationDate : "Subscription"
                },
                {   
                    Unassign : removeUserFromRole
                },
                {
                    id : userDetails
                },
                {
                    label : "Assign",
                    function : addUserFromRole,
                    selectLabelColumn : "username",
                    options : users
                }
            ));
            role_details.appendChild(users_with_role);


            let permissions_of_role = document.createElement("div");
            permissions_of_role.classList.add("permissions-of-role");
            permissions_of_role.innerHTML = `<h3>Permissions of this role</h3>`;
            permissions_of_role.appendChild(createTable(response.data.permissions,
                {
                    action_id : "Action",
                    library_id : "Library",
                    module_id : "Module",
                    action_description : "Description"
                },
                {   
                    Unassign : removePermissionFromRole
                    id_name : "action_id"
                },
                {
                    action_id : permissionDetails
                },
                {
                    label : "Assign",
                    function : addPermissionToRole,
                    selectLabelColumn : "action_id",
                    options : actions,
                    id_name : "action_id"

                }
            ));
            
            role_details.appendChild(permissions_of_role);

            openModal(`${role.id} - ${role.role_name.toUpperCase()}`, role_details, role.id);
        } else {
            promptError(response);
        }
    }

    async function removePermissionFromRole(id, lineElement) {
        console.log("Remove permission " + id + " : " + current_modal_id);
        let response = await request("Core", "Permission", "ActionAssign", false, "DELETE", {
            "role_id" : parseInt(current_modal_id),
            "action_id" : id
        });
        if(!response.success) promptError(response);
        return response.success;
    }

    async function addPermissionToRole(id) {
        let response = await request("Core", "Permission", "ActionAssign", false, "POST", {
            "role_id" : parseInt(current_modal_id),
            "action_id" : id
        });
        if(!response.success) promptError(response);
        return response.success;
    }

    async function permissionDetails(id) {
        if(!id) return;
        console.log("Permission detials " + id);
    }

    async function editRole(field, value) {
        let response = await request("Core", "Permission", "Role", current_modal_id, "PATCH", 
            { [field] : value }
        );
        //console.log(response);

        if(!response.success) promptError(response);
        return response.success;
    }
    async function addUserFromRole(id) {
        let response = await request("Core", "Permission", "RoleAssign", false, "POST", {
            "role_id" : parseInt(current_modal_id),
            "user_id" : parseInt(id)
        });
        if(!response.success) promptError(response);
        return response.success;
    }

    async function removeUserFromRole(id, lineElement) {
        let response = await request("Core", "Permission", "RoleAssign", false, "DELETE", {
            "role_id" : parseInt(current_modal_id),
            "user_id" : parseInt(id)
        });
        if(!response.success) promptError(response);
        return response.success;
    }

    /** USER DETAILS PART **/
    async function userDetails(id) {
        let response = await request("Core", "Permission", "User", id, "GET");
        if(response.success) {

            let user = response.data.user;
            let user_details = document.createElement("div");

            user_details.appendChild(createDataList(
                user,
                {
                    first_name : "First name",
                    last_name : "Last name",
                    email : "E-mail",
                    username : "Login",
                    creationDate : "Subscription"
                },
                {
                    first_name : editUser,
                    last_name : editUser,
                    email : editUser,
                    username : editUser
                }
            ));
            user_details.appendChild(document.createElement("hr"));
            let user_roles = document.createElement("div");
            user_roles.classList.add("user-roles");
            user_roles.innerHTML = `<h3>Roles</h3>`;
            user_roles.appendChild(createTable(response.data.roles,
                {
                    id : "Role ID",
                    role_name : "Name",
                    role_description : "Description",
                    creationDate : "Creation date"
                },
                {   
                    Unassign : removeRole
                },
                {
                    id : roleDetails
                },
                {
                    label : "Assign",
                    function : addRole,
                    selectLabelColumn : "role_name",
                    options : roles
                }
            ));
            user_details.appendChild(user_roles);
            openModal(`${user.id} - ${user.first_name} ${user.last_name.toUpperCase()}`, user_details, user.id);
        } else {
            promptError(response);
        }
    }

    async function editUser(field, value) {
        console.log(field, value);
        let response = await request("Core", "Permission", "User", current_modal_id, "PATCH", 
            { [field] : value } 
        );
        if(!response.success) promptError(response);
        return response.success;
    }

    async function removeRole(id, lineElement) {
        let response = await request("Core", "Permission", "RoleAssign", false, "DELETE", {
            "role_id" : parseInt(id),
            "user_id" : parseInt(current_modal_id)
        });
        if(!response.success) promptError(response);
        return response.success;
    }

    async function addRole(id) {
        let response = await request("Core", "Permission", "RoleAssign", false, "POST", {
            "role_id" : parseInt(id),
            "user_id" : parseInt(current_modal_id)
        });
        if(!response.success) promptError(response);
        return response.success;
    }




    function promptError(response) {
        if(!response.success) return; 
        let errors = "";
        response.errors.forEach(function(error) {
            errors += error.error + " : " + error.description + "\n";
        });
        response.warnings.forEach(function(warning) {
            errors += warning.warning + " : " + warning.description + "\n";
        });

        alert(errors);
    }

    function createSubPart(title) {
        let subpart = document.createElement("div");
        let subpart_title = document.createElement("h3");
        subpart_title.classList.add("subpart-title");
        subpart_title.innerText = title;
        subpart.appendChild(subpart_title);
        subpart.appendChild(document.createElement("hr"));
        return subpart;
    }


    
    function openModal(title, content, id = false) {
        
        id ? current_modal_id = id : current_modal_id = false;
        modal.classList.remove("hide");
        document.getElementById("modal-title").innerText = title;
        let modal_text = document.getElementById("modal-text");
        modal_text.innerHTML = "";
        modal_text.appendChild(content)
        document.getElementById("modal-close").addEventListener("click", function() {
            closeModal();
        });
    }

    function closeModal() {
        modal.classList.add("hide");
        document.getElementById("modal-text").innerHTML = "";
        document.getElementById("modal-title").innerText = "";
    }

    async function checkDBSetup() {
        let response = false;
        response = await request("Core", "Setup", "isSetup", id = false, method = "GET");
        if(getError(response, "db_not_setup")) {
            document.getElementById("config-db").classList.remove("hide");
        } else {
            document.getElementById("categories").classList.remove("hide");
            document.getElementById("category-content").classList.remove("hide");
            document.getElementById("nav-history").classList.remove("hide");
        }
    }

    async function setCategory(category) {
        category_content.innerHTML = "";
        /* Remove selected class from all categories */
        let categories = document.getElementById("categories").getElementsByTagName("li");
        Array.from(categories).forEach(function(category) {
            category.classList.remove("selected");
        });
        /* Add selected class to clicked category */
        category.classList.add("selected");

        let category_title = document.createElement("h2");
        category_title.classList.add("category-title");
        category_title.innerText = category.innerText;
        category_content.appendChild(category_title);

        if(category.innerText == "Users") {
            category_content.appendChild(await createUserCategory());
        } else if(category.innerText == "Permissions") {
            category_content.appendChild(await createPermissionCategory());
        } else if(category.innerText == "Logs") {
            category_content.appendChild(await createLogCategory());
        } else if(category.innerText == "API Rest") {
            category_content.appendChild(await createAPIRestCategory());
        } else if(category.innerText == "Statistiques") {
            category_content.appendChild(await createStatistiquesCategory());
        }
    } 


    async function setupDBForm() {
        let form = document.getElementById("form-db");
        form.addEventListener("submit", function(e) {e.preventDefault();});
        let admin_mail = document.getElementById("admin_mail").value;
        let admin_password = document.getElementById("admin_password").value;
        let admin_firstname = document.getElementById("admin_firstname").value;
        let admin_lastname = document.getElementById("admin_lastname").value;

        let response = await request("Core", "Setup", "SetupDB", false, "POST",
            {
                "admin_mail" : admin_mail,
                "admin_password" : admin_password,
                "admin_firstname" : admin_firstname,
                "admin_lastname" : admin_lastname
            }
        );

        response = await request("Core", "Setup", "UpdateModule", "Core", "PATCH");

    }


    function createDataList(data, labels, editableLines) {
        let element = document.createElement("div");
        element.classList.add("data-list");
        for(let label in labels) {

            let line = document.createElement("p");
            line.classList.add("data-line");
            let label_element = document.createElement("b");
            label_element.innerText = labels[label] + " : ";
            line.appendChild(label_element);
            let value_element = document.createElement("span");
            value_element.innerText = data[label];
            line.appendChild(value_element);

            /* Add edit button at the line end
              If button pressed, the span (value_element) became editable and the button became a "save" button
            */
            if(editableLines[label]) {
                let edit_button = document.createElement("button");
                edit_button.innerText = "Edit";
                edit_button.addEventListener("click", async function() {
                    if(edit_button.innerText == "Edit") {
                        edit_button.innerText = "Save";
                        // border of the editable element became balck
                        value_element.style.border = "1px solid black";
                        value_element.contentEditable = true;

                    } else {
                        edit_button.innerText = "Edit";
                        // border of the editable element became transparent
                        value_element.style.border = "1px solid transparent";
                        value_element.contentEditable = false;

                        // send request to edit the element
                        if(!await editableLines[label](label, value_element.innerText)) {
                            value_element.innerText = data[label];
                        }

                    }
                });
                line.appendChild(edit_button);
            }

            element.appendChild(line);
        }
        return element;
    }


    function createTable(data, columns, delete_actions, references, addExisting = false, createNew = false) {
        let table = document.createElement("table");
        table.classList.add("sortable");
        table.classList.add("col-10");

        let thead = document.createElement("thead");
        let tr = document.createElement("tr");

        for(let column in columns) {
            let th = document.createElement("th");
            th.innerText = columns[column];
    

            // add sort button on columns
            let sort_button = document.createElement("span");
            sort_button.classList.add("sort-button");
            sort_button.innerText = "▲";
            sort_button.addEventListener("click", function() {
                sortTable(table, column, sort_button.innerText == "▲" ? "desc" : "asc");
                sort_button.innerText = sort_button.innerText == "▲" ? "▼" : "▲";
            });
            th.appendChild(sort_button);
            tr.appendChild(th);
        }

        // add actions column
        let th = document.createElement("th");
        th.innerText = "Actions";
        tr.appendChild(th);


        thead.appendChild(tr);
        table.appendChild(thead);
        let renamed_data = [];
        for(let i = 0; i < data.length; i++) {
            renamed_data[i] = {};
            for(let column in columns) {
                renamed_data[i][column] = data[i][column];
            }
        }

        let tbody = document.createElement("tbody");
        for(let i = 0; i < renamed_data.length; i++) {
            let tr = document.createElement("tr");
            for(let column in renamed_data[i]) {
                let td = document.createElement("td");
                
                if(references[column]) {
                   td.classList.add("reference");
                    td.addEventListener("click", function() {
                        references[column](renamed_data[i][column]);
                    });
                } else {
                    td.innerText = renamed_data[i][column];
                }


                td.classList.add(column);
                td.innerText = renamed_data[i][column];
                tr.appendChild(td);
                
            }

            // add actions buttons
            let td = document.createElement("td");
            for(let action in delete_actions) {
                let button = document.createElement("button");
                button.innerText = action;
                button.addEventListener("click", async function() {
                    let id_name = delete_actions[action].id_name ? delete_actions[action].id_name : "id";
                    if(await delete_actions[action](renamed_data[i][id_name])) {
                        tr.remove();
                    }
                });
                td.appendChild(button);
            }
            tr.appendChild(td);
            tbody.appendChild(tr);


        }

        // create element
        if(addExisting) {
            let tr = document.createElement("tr");
            tr.classList.add("create-element");
            let select = document.createElement("select");
            let option = document.createElement("option");
            option.innerText = "Select";
            option.disabled = true;
            option.selected = true;
            select.appendChild(option);
            for(let option in addExisting.options) {
                let option_element = document.createElement("option");
                option_element.innerText = addExisting.options[option][addExisting.selectLabelColumn];
                if(!addExisting.id_name) option_element.value = addExisting.options[option].id;
                else option_element.value = addExisting.options[option][addExisting.id_name];
                select.appendChild(option_element);
            }

            for(let column in columns) {
                let td = document.createElement("td");
                td.classList.add(column);
                if(column == addExisting.selectLabelColumn) {
                    td.appendChild(select);
                }
                tr.appendChild(td);
            }

            let button = document.createElement("button");

            select.addEventListener("change", function() {
                // Set all td of the line with the value of the selected role
                let tds = tr.getElementsByTagName("td");
                for(let i = 0; i < tds.length-1; i++) {
                    if(tds[i].classList[0] != addExisting.selectLabelColumn)
                    tds[i].innerText = addExisting.options[select.selectedIndex - 1][tds[i].classList[0]];

                    // reference click 
                    if(references[tds[i].classList[0]]) {
                        tds[i].classList.add("reference");
                        tds[i].addEventListener("click", function() {
                            references[tds[i].classList[0]](select.value);
                        });
                    }

                }
                button.disabled = false;
            });

            // add create button
            let td = document.createElement("td");
            button.disabled = true;
            button.innerText = addExisting.label;
            button.addEventListener("click", async function() {
                let creation_success = await addExisting.function(select.value)
                if(creation_success) {
                    // add new line with the selected role
                    let new_tr = document.createElement("tr");
                    for(let column in columns) {
                        let td = document.createElement("td");
                        td.classList.add(column);
                        td.innerText = addExisting.options[select.selectedIndex - 1][td.classList[0]];

                        if(references[column]) {
                            td.classList.add("reference");
                            td.addEventListener("click", function() {
                                references[column](select.value);
                            });
                        }

                        new_tr.appendChild(td);
                    }
                    let td = document.createElement("td");
                    for(let action in delete_actions) {
                        let button = document.createElement("button");
                        button.innerText = action;
                        button.addEventListener("click", function() {
                            if(delete_actions[action](select.value)) {
                                new_tr.remove();
                            }
                        });

                       
                        td.appendChild(button);
                    }
                    new_tr.appendChild(td);
                    tbody.appendChild(new_tr);
                    /* Exchange 2 last lines */
                    tbody.insertBefore(new_tr, tbody.lastChild);
                    tbody.insertBefore(tbody.lastChild, tbody.lastChild.previousSibling);
                    
                }
            });
            td.appendChild(button);
            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        if(createNew) {
            let tr = document.createElement("tr");
            tr.classList.add("create-element");
            for(let column in columns) {
                let td = document.createElement("td");
                td.classList.add(column);
                if(createNew.needed_columns.includes(column)) {
                    let input = document.createElement("input");
                    input.type = "text";
                    input.placeholder = column;
                    td.appendChild(input);
                }
                tr.appendChild(td);
            }

            let button = document.createElement("button");
            let td = document.createElement("td");
            button.innerText = createNew.label;
            button.addEventListener("click", async function() {
                let data = {};
                for(let column in columns) {
                    if(createNew.needed_columns.includes(column)) {
                        data[column] = tr.getElementsByClassName(column)[0].getElementsByTagName("input")[0].value;
                    }
                }
                
                let creation_success = await createNew.function(false, data);
                if(creation_success.success) {
                    let newData = creation_success; 
                    // add new line with the selected role
                    let new_tr = document.createElement("tr");
                    for(let column in columns) {
                        let td = document.createElement("td");
                        td.classList.add(column);
                        td.innerText = newData[column];

                        if(references[column]) {
                            td.classList.add("reference");
                            td.addEventListener("click", function() {
                                
                                references[column](newData.id);
                            });
                        }

                        new_tr.appendChild(td);
                    }
                    let td = document.createElement("td");
                    for(let action in delete_actions) {
                        let button = document.createElement("button");
                        button.innerText = action;
                        button.addEventListener("click", function() {
                            if(delete_actions[action](newData.id)) {
                                new_tr.remove();
                            }
                        });

                       
                        td.appendChild(button);
                    }
                    new_tr.appendChild(td);
                    tbody.appendChild(new_tr);
                    /* Exchange 2 last lines */
                    tbody.insertBefore(new_tr, tbody.lastChild);
                    tbody.insertBefore(tbody.lastChild, tbody.lastChild.previousSibling);

                    // clear inputs
                    for(let column in columns) {
                        if(createNew.needed_columns.includes(column)) {
                            tr.getElementsByClassName(column)[0].getElementsByTagName("input")[0].value = "";
                        }
                    }

                }
            });
            td.appendChild(button);
            tr.appendChild(td);
            tbody.appendChild(tr);
        }


        table.appendChild(tbody);
        return table;
    }

    function sortTable(table, column, order) {
        let tbody = table.getElementsByTagName("tbody")[0];
        let rows = tbody.getElementsByTagName("tr");
        let rows_array = Array.from(rows);

        let create_element_row = tbody.getElementsByClassName("create-element")[0];
        if(create_element_row) {
            rows_array.splice(rows_array.indexOf(create_element_row), 1);
        }


        rows_array.sort(function(a, b) {
            let a_value = a.getElementsByClassName(column)[0].innerText;
            let b_value = b.getElementsByClassName(column)[0].innerText;
            
            
            if(order == "asc") {
                if(a_value < b_value) return -1;
                if(a_value > b_value) return 1;
                return 0;
            } else {
                if(a_value > b_value) return -1;
                if(a_value < b_value) return 1;
                return 0;
            }
        });
        tbody.innerHTML = "";
        rows_array.forEach(function(row) {
            tbody.appendChild(row);
        });
        if(create_element_row) {
            tbody.appendChild(create_element_row);
        }
        
    }




    
    </script>
</body>
</html>
